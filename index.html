<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול תקציב אישי - ענן</title>
    <!-- טעינת עיצוב Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- אייקונים -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* התאמות נוספות */
        body { font-family: system-ui, -apple-system, sans-serif; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen p-4 md:p-8">

    <div class="max-w-4xl mx-auto space-y-6">
        
        <!-- כותרת ראשית -->
        <header class="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
            <div class="flex items-center gap-3 mb-4 md:mb-0">
                <div class="bg-blue-600 p-3 rounded-xl text-white">
                    <i data-lucide="cloud" class="w-7 h-7"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-slate-900">ניהול תקציב אישי</h1>
                    <div class="flex items-center gap-2 text-slate-500 text-sm">
                        <span id="status-text">מתחבר לענן...</span>
                        <i id="loading-spinner" data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="exportData()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium">
                    <i data-lucide="download" class="w-4 h-4"></i>
                    גיבוי לקובץ
                </button>
                <button onclick="document.getElementById('file-input').click()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 hover:bg-slate-200 text-slate-700 rounded-lg transition-colors text-sm font-medium">
                    <i data-lucide="upload" class="w-4 h-4"></i>
                    טעינה לענן
                </button>
                <input type="file" id="file-input" class="hidden" accept=".json" onchange="importData(this)">
            </div>
        </header>

        <!-- כרטיסי סיכום -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <!-- יתרה -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                <p class="text-slate-500 text-sm mb-1">יתרה נוכחית</p>
                <h2 id="total-balance" class="text-3xl font-bold text-slate-800">₪0.00</h2>
            </div>
            
            <!-- הכנסות -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center">
                <div>
                    <p class="text-slate-500 text-sm mb-1">סך הכנסות</p>
                    <h2 id="total-income" class="text-2xl font-bold text-emerald-600">₪0.00</h2>
                </div>
                <div class="bg-emerald-100 p-3 rounded-full text-emerald-600">
                    <i data-lucide="trending-up" class="w-6 h-6"></i>
                </div>
            </div>

            <!-- הוצאות -->
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 flex justify-between items-center">
                <div>
                    <p class="text-slate-500 text-sm mb-1">סך הוצאות</p>
                    <h2 id="total-expense" class="text-2xl font-bold text-red-500">₪0.00</h2>
                </div>
                <div class="bg-red-100 p-3 rounded-full text-red-500">
                    <i data-lucide="trending-down" class="w-6 h-6"></i>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- טופס הוספה -->
            <div class="lg:col-span-1">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 h-full">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="plus" class="text-blue-600 w-5 h-5"></i>
                        הוספת תנועה חדשה
                    </h3>
                    <form id="transaction-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">תיאור</label>
                            <input type="text" id="desc" placeholder="לדוגמה: קניות בסופר" required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">סכום (₪)</label>
                            <input type="number" id="amount" placeholder="0.00" min="0" step="0.01" required
                                class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">סוג תנועה</label>
                            <div class="grid grid-cols-2 gap-2 bg-slate-100 p-1 rounded-lg">
                                <button type="button" id="btn-expense" onclick="setType('expense')" 
                                    class="py-2 px-4 rounded-md text-sm font-medium transition-all bg-white text-red-600 shadow-sm">
                                    הוצאה
                                </button>
                                <button type="button" id="btn-income" onclick="setType('income')" 
                                    class="py-2 px-4 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700">
                                    הכנסה
                                </button>
                            </div>
                        </div>

                        <button type="submit" id="submit-btn" disabled
                            class="w-full mt-4 bg-blue-600 hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed text-white font-medium py-2.5 rounded-lg transition-colors shadow-sm flex justify-center items-center gap-2">
                            הוסף לרשימה
                        </button>
                    </form>
                </div>
            </div>

            <!-- רשימת תנועות -->
            <div class="lg:col-span-2">
                <div class="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 min-h-[500px]">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-lucide="file-json" class="text-blue-600 w-5 h-5"></i>
                        היסטוריית תנועות
                    </h3>
                    
                    <div id="list-container" class="space-y-3 max-h-[500px] overflow-y-auto pr-2 custom-scrollbar">
                        <!-- התוכן יוזרק כאן דינמית -->
                        <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                            <i data-lucide="wallet" class="w-12 h-12 mb-3 bg-slate-50 p-2 rounded-full"></i>
                            <p>טוען נתונים...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- פוטר -->
        <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 flex items-start gap-3">
            <i data-lucide="alert-circle" class="text-blue-600 w-5 h-5 mt-0.5 shrink-0"></i>
            <div class="text-sm text-blue-800">
                <strong>מצב ענן פעיל:</strong> הנתונים מסונכרנים בזמן אמת.
                <br/>
                מזהה משתמש נוכחי: <span id="user-id" class="font-mono text-xs">...</span>
            </div>
        </div>
    </div>

    <!-- Firebase Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, deleteDoc, doc, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // הגדרות FIREBASE - חובה למלא!
        // ==========================================
        // 1. לך לכתובת console.firebase.google.com
        // 2. צור פרויקט חדש
        // 3. תחת "Build", הפעל את "Authentication" (בחר ב-Anonymous)
        // 4. תחת "Build", הפעל את "Firestore Database" (במצב Test Mode להתחלה)
        // 5. בהגדרות הפרויקט (Project Settings), העתק את ה-Config והדבק כאן למטה:
        
        const firebaseConfig = {
            apiKey: "AIzaSyDP2WfDKFKb7KIn8Dz9zmB5c69ihYon08M",
            authDomain: "own-finance-tracker-c13b7.firebaseapp.com",
            projectId: "own-finance-tracker-c13b7",
            storageBucket: "own-finance-tracker-c13b7.firebasestorage.app",
            messagingSenderId: "897821764976",
            appId: "1:897821764976:web:a98acc7b547b79aa2873b5"
        };

        // אתחול משתנים גלובליים
        let app, auth, db;
        let currentUser = null;
        let currentType = 'expense';
        let transactions = [];

        // נסה לאתחל את Firebase רק אם ההגדרות תקינות
        try {
            if (firebaseConfig.apiKey === "YOUR_API_KEY_HERE") {
                throw new Error("נא לעדכן את קובץ ה-HTML עם הגדרות ה-Firebase שלך");
            }
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            initApp();
        } catch (e) {
            console.error(e);
            document.getElementById('status-text').innerText = "שגיאת הגדרות (פתח קונסול)";
            document.getElementById('status-text').classList.add('text-red-500');
            document.getElementById('loading-spinner').style.display = 'none';
            alert("שים לב: עליך לערוך את קובץ ה-HTML ולהוסיף את הגדרות ה-Firebase שלך כדי שהאפליקציה תעבוד.");
        }

        function initApp() {
            // התחברות אנונימית
            signInAnonymously(auth).catch((error) => {
                console.error("Auth Error:", error);
            });

            // האזנה לשינויי התחברות
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('user-id').innerText = user.uid;
                    document.getElementById('status-text').innerText = "מחובר לענן";
                    document.getElementById('loading-spinner').style.display = 'none';
                    document.getElementById('submit-btn').disabled = false;
                    
                    // התחל להאזין לנתונים
                    listenToData();
                } else {
                    currentUser = null;
                    document.getElementById('status-text').innerText = "מנותק";
                    document.getElementById('submit-btn').disabled = true;
                }
            });
        }

        // האזנה לשינויים ב-Firestore
        function listenToData() {
            const q = query(collection(db, "users", currentUser.uid, "transactions")); // שליפה פשוטה, מיון בצד לקוח
            
            onSnapshot(q, (snapshot) => {
                transactions = [];
                snapshot.forEach((doc) => {
                    transactions.push({ id: doc.id, ...doc.data() });
                });
                
                // מיון לפי תאריך (חדש לישן)
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                renderList();
                updateTotals();
            });
        }

        // --- לוגיקת UI ---

        // בחירת סוג (הכנסה/הוצאה)
        window.setType = (type) => {
            currentType = type;
            const btnExpense = document.getElementById('btn-expense');
            const btnIncome = document.getElementById('btn-income');

            if (type === 'expense') {
                btnExpense.className = "py-2 px-4 rounded-md text-sm font-medium transition-all bg-white text-red-600 shadow-sm";
                btnIncome.className = "py-2 px-4 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700";
            } else {
                btnIncome.className = "py-2 px-4 rounded-md text-sm font-medium transition-all bg-white text-emerald-600 shadow-sm";
                btnExpense.className = "py-2 px-4 rounded-md text-sm font-medium transition-all text-slate-500 hover:text-slate-700";
            }
        };

        // שליחת טופס
        document.getElementById('transaction-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;

            const desc = document.getElementById('desc').value;
            const amount = document.getElementById('amount').value;

            try {
                await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                    description: desc,
                    amount: parseFloat(amount),
                    type: currentType,
                    date: new Date().toISOString()
                });

                // איפוס טופס
                document.getElementById('desc').value = '';
                document.getElementById('amount').value = '';
            } catch (error) {
                console.error("Error adding doc: ", error);
                alert("שגיאה בהוספה");
            }
        });

        // מחיקה
        window.deleteItem = async (id) => {
            if (!currentUser || !confirm("האם למחוק שורה זו?")) return;
            try {
                await deleteDoc(doc(db, "users", currentUser.uid, "transactions", id));
            } catch (error) {
                console.error("Error deleting: ", error);
            }
        };

        // רינדור הרשימה
        function renderList() {
            const container = document.getElementById('list-container');
            
            if (transactions.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-64 text-slate-400">
                        <div class="bg-slate-50 p-4 rounded-full mb-3"><i data-lucide="wallet" class="w-8 h-8"></i></div>
                        <p>אין נתונים עדיין.</p>
                    </div>`;
                lucide.createIcons();
                return;
            }

            let html = '';
            transactions.forEach(t => {
                const isIncome = t.type === 'income';
                const colorClass = isIncome ? 'text-emerald-600' : 'text-red-500';
                const bgClass = isIncome ? 'bg-emerald-100' : 'bg-red-100';
                const sign = isIncome ? '+' : '-';
                const iconName = isIncome ? 'trending-up' : 'trending-down';
                const dateStr = new Date(t.date).toLocaleDateString('he-IL');

                html += `
                <div class="group flex items-center justify-between p-4 rounded-xl border border-slate-100 hover:border-blue-100 hover:bg-blue-50/50 transition-all bg-white">
                    <div class="flex items-center gap-4">
                        <div class="p-2 rounded-lg ${bgClass} ${colorClass}">
                            <i data-lucide="${iconName}" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h4 class="font-medium text-slate-800">${t.description}</h4>
                            <p class="text-xs text-slate-500">${dateStr}</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-bold font-mono ${colorClass}">${sign}₪${t.amount.toLocaleString()}</span>
                        <button onclick="deleteItem('${t.id}')" class="text-slate-300 hover:text-red-500 transition-colors p-2 hover:bg-red-50 rounded-lg opacity-0 group-hover:opacity-100 focus:opacity-100">
                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>`;
            });

            container.innerHTML = html;
            lucide.createIcons();
        }

        // עדכון סיכומים
        function updateTotals() {
            const income = transactions.filter(t => t.type === 'income').reduce((acc, t) => acc + t.amount, 0);
            const expense = transactions.filter(t => t.type === 'expense').reduce((acc, t) => acc + t.amount, 0);
            const balance = income - expense;

            document.getElementById('total-income').innerText = `₪${income.toLocaleString()}`;
            document.getElementById('total-expense').innerText = `₪${expense.toLocaleString()}`;
            
            const balEl = document.getElementById('total-balance');
            balEl.innerText = `₪${balance.toLocaleString()}`;
            balEl.className = `text-3xl font-bold ${balance >= 0 ? 'text-slate-800' : 'text-red-500'}`;
        }

        // --- ייצוא וייבוא ---
        
        window.exportData = () => {
            const dataStr = JSON.stringify(transactions, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `budget_backup_${new Date().toISOString().slice(0, 10)}.json`;
            link.click();
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file || !currentUser) return;

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data) && confirm(`לטעון ${data.length} רשומות לענן?`)) {
                        let count = 0;
                        for (const item of data) {
                             await addDoc(collection(db, "users", currentUser.uid, "transactions"), {
                                description: item.description || "מיובא",
                                amount: parseFloat(item.amount) || 0,
                                type: item.type || 'expense',
                                date: item.date || new Date().toISOString()
                            });
                            count++;
                        }
                        alert("נטען בהצלחה!");
                    }
                } catch (err) {
                    alert("שגיאה בטעינת הקובץ");
                }
            };
            reader.readAsText(file);
            input.value = '';
        };

        // הפעלה ראשונית של האייקונים
        lucide.createIcons();
    </script>
</body>
</html>
